<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 5. Spatial Queries</title>
    <link rel="stylesheet" type="text/css" href="../style.css"/>
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.2"/>
    <link rel="prev" href="using_postgis_dbmanagement.html" title="Chapter 4. Data Management"/>
    <link rel="next" href="performance_tips.html" title="Chapter 6. Performance Tips"/>
  </head>
  <body>
    <header>
      <div class="navheader">
        <table style="width: 100%; ">
          <tr>
            <th style="text-align: center; " colspan="3">Chapter 5. Spatial Queries</th>
          </tr>
          <tr>
            <td style="width: 20%; text-align: left; "><a accesskey="p" href="using_postgis_dbmanagement.html">Prev</a> </td>
            <th style="width: 60%; text-align: center; "> </th>
            <td style="width: 20%; text-align: right; "> <a accesskey="n" href="performance_tips.html">Next</a></td>
          </tr>
        </table>
      </div>
    </header>
    <section class="chapter" id="using_postgis_query">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title">Chapter 5. Spatial Queries</h1>
          </div>
        </div>
      </div>
      <div class="toc">
        <div class="toc-title">Table of Contents</div>
        <ul class="toc">
          <li>
            <span class="section">
              <a href="using_postgis_query.html#eval_spatial_rel">5.1. Determining Spatial Relationships</a>
            </span>
          </li>
          <li>
            <span class="section">
              <a href="using_postgis_query.html#using-query-indexes">5.2. Using Spatial Indexes</a>
            </span>
          </li>
          <li>
            <span class="section">
              <a href="using_postgis_query.html#examples_spatial_sql">5.3. Examples of Spatial SQL</a>
            </span>
          </li>
        </ul>
      </div>
      <p>The <span class="emphasis"><em>raison d'etre</em></span> of spatial databases
	is to perform queries inside the database which would
	ordinarily require desktop GIS functionality. Using PostGIS effectively
	requires knowing what spatial functions are available,
    how to use them in queries, and ensuring that
	appropriate indexes are in place to provide good performance.
    </p>
      <section class="section" id="eval_spatial_rel">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both">5.1. Determining Spatial Relationships</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <ul class="toc">
            <li>
              <span class="section">
                <a href="using_postgis_query.html#DE-9IM">5.1.1. Dimensionally Extended 9-Intersection Model</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_postgis_query.html#named-spatial-rel">5.1.2. Named Spatial Relationships</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_postgis_query.html#general-spatial-rel">5.1.3. General Spatial Relationships</a>
              </span>
            </li>
          </ul>
        </div>
        <p>Spatial relationships indicate how two geometries interact with one another.
        They are a fundamental capability for querying geometry.
        </p>
        <section class="section" id="DE-9IM">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">5.1.1. Dimensionally Extended 9-Intersection Model</h3>
              </div>
            </div>
          </div>
          <p>According to the <a class="link" href="http://www.opengeospatial.org/standards/sfs" target="_top">OpenGIS Simple
          Features Implementation Specification for SQL</a>, "the basic
          approach to comparing two geometries is to make pair-wise tests of
          the intersections between the Interiors, Boundaries and Exteriors of
          the two geometries and to classify the relationship between the two
          geometries based on the entries in the resulting 'intersection'
          matrix."</p>
          <p>In the theory of point-set topology,
        the points in a geometry embedded in 2-dimensional space are categorized into three sets:
        </p>
          <div class="glosslist">
            <dl>
              <dt>
                <span class="glossterm">Boundary</span>
              </dt>
              <dd class="glossdef">
                <p>The boundary of a geometry is the set of geometries of
                the next lower dimension. For <code class="varname">POINT</code>s, which
                have a dimension of 0, the boundary is the empty set. The
                boundary of a <code class="varname">LINESTRING</code> is the two
                endpoints. For <code class="varname">POLYGON</code>s, the boundary is
                the linework of the exterior and interior
                rings.</p>
              </dd>
              <dt>
                <span class="glossterm">Interior</span>
              </dt>
              <dd class="glossdef">
                <p>The interior of a geometry are those points of a
                geometry that are not in the boundary. For
                <code class="varname">POINT</code>s, the interior is the
                point itself. The interior of a
                <code class="varname">LINESTRING</code> is the set of points
                between the endpoints. For <code class="varname">POLYGON</code>s, the
                interior is the areal surface inside the polygon.</p>
              </dd>
              <dt>
                <span class="glossterm">Exterior</span>
              </dt>
              <dd class="glossdef">
                <p>The exterior of a geometry is the rest of the space
                in which the geometry is embedded;
                in other words, all points not in the interior or on the boundary of the geometry.
                It is a 2-dimensional non-closed surface.
                </p>
              </dd>
            </dl>
          </div>
          <p>The <a class="link" href="http://en.wikipedia.org/wiki/DE-9IM" target="_top">Dimensionally Extended 9-Intersection Model</a>
        (DE-9IM) describes the spatial relationship between two geometries
        by specifying the dimensions of the 9 intersections between the above sets for each geometry.
        The intersection dimensions can be formally represented
        in a 3x3 <span class="bold"><strong>intersection matrix</strong></span>.
        </p>
          <p>For a geometry <span class="emphasis"><em>g</em></span>
            the <span class="emphasis"><em>Interior</em></span>, <span class="emphasis"><em>Boundary</em></span>, and <span class="emphasis"><em>Exterior</em></span>
            are denoted using the notation
          <span class="emphasis"><em>I(g)</em></span>, <span class="emphasis"><em>B(g)</em></span>, and
          <span class="emphasis"><em>E(g)</em></span>.
          Also, <span class="emphasis"><em>dim(s)</em></span> denotes the dimension of
          a set <span class="emphasis"><em>s</em></span> with the domain of
          <code class="literal">{0,1,2,F}</code>:
        </p>
          <div class="itemizedlist">
            <ul class="itemizedlist compact" style="list-style-type: disc; ">
              <li class="listitem">
                <p><code class="literal">0</code> =&gt; point</p>
              </li>
              <li class="listitem">
                <p><code class="literal">1</code> =&gt; line</p>
              </li>
              <li class="listitem">
                <p><code class="literal">2</code> =&gt; area</p>
              </li>
              <li class="listitem">
                <p><code class="literal">F</code> =&gt; empty set</p>
              </li>
            </ul>
          </div>
          <p>
          Using this notation, the intersection matrix
          for two geometries <span class="emphasis"><em>a</em></span> and <span class="emphasis"><em>b</em></span> is:</p>
          <div class="styledtable">
            <table style="border-collapse: collapse; border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; ">
              <colgroup>
                <col/>
                <col/>
                <col/>
                <col/>
              </colgroup>
              <thead>
                <tr>
                  <th style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; "> </th>
                  <th style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; ">
                    <span class="bold">
                      <strong>Interior</strong>
                    </span>
                  </th>
                  <th style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; ">
                    <span class="bold">
                      <strong>Boundary</strong>
                    </span>
                  </th>
                  <th style="text-align: center; border-bottom: 1px solid ; ">
                    <span class="bold">
                      <strong>Exterior</strong>
                    </span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; ">
                    <span class="bold">
                      <strong>Interior</strong>
                    </span>
                  </td>
                  <td style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; ">
                    <span class="emphasis">
                      <em>dim( I(a) ∩ I(b) )</em>
                    </span>
                  </td>
                  <td style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; ">
                    <span class="emphasis">
                      <em>dim( I(a) ∩ B(b) )</em>
                    </span>
                  </td>
                  <td style="text-align: center; border-bottom: 1px solid ; ">
                    <span class="emphasis">
                      <em>dim( I(a) ∩ E(b) )</em>
                    </span>
                  </td>
                </tr>
                <tr>
                  <td style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; ">
                    <span class="bold">
                      <strong>Boundary</strong>
                    </span>
                  </td>
                  <td style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; ">
                    <span class="emphasis">
                      <em>dim( B(a) ∩ I(b) )</em>
                    </span>
                  </td>
                  <td style="text-align: center; border-right: 1px solid ; border-bottom: 1px solid ; ">
                    <span class="emphasis">
                      <em>dim( B(a) ∩ B(b) )</em>
                    </span>
                  </td>
                  <td style="text-align: center; border-bottom: 1px solid ; ">
                    <span class="emphasis">
                      <em>dim( B(a) ∩ E(b) )</em>
                    </span>
                  </td>
                </tr>
                <tr>
                  <td style="text-align: center; border-right: 1px solid ; ">
                    <span class="bold">
                      <strong>Exterior</strong>
                    </span>
                  </td>
                  <td style="text-align: center; border-right: 1px solid ; ">
                    <span class="emphasis">
                      <em>dim( E(a) ∩ I(b) )</em>
                    </span>
                  </td>
                  <td style="text-align: center; border-right: 1px solid ; ">
                    <span class="emphasis">
                      <em>dim( E(a) ∩ B(b) )</em>
                    </span>
                  </td>
                  <td style="text-align: center; ">
                    <span class="emphasis">
                      <em>dim( E(a) ∩ E(b) )</em>
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p>Visually, for two overlapping polygonal geometries, this looks like:</p>
          <div class="informaltable">
            <table style="border: none;">
              <colgroup>
                <col style="width: 80pt; "/>
                <col/>
              </colgroup>
              <tbody>
                <tr>
                  <td style="border-right: 1px solid ; border-bottom: 1px solid ; "> </td>
                  <td style="text-align: center; border-bottom: 1px solid ; ">
                    <div class="informalfigure">
                      <div style="text-align: center; " class="mediaobject">
                        <table style="border: 0; cellpadding: 0; cellspacing: 0;">
                          <tr>
                            <td style="text-align: center; vertical-align: middle; ">
                              <img style="text-align: middle; " src="../images/de9im04.png"/>
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td style="text-align: center; vertical-align: middle; border-right: 1px solid ; ">
                    <div class="informalfigure">
                      <div style="text-align: center; " class="mediaobject">
                        <table style="border: 0; cellpadding: 0; cellspacing: 0;">
                          <tr>
                            <td style="text-align: center; vertical-align: middle; ">
                              <img style="text-align: middle; " src="../images/de9im03.png"/>
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </td>
                  <td>
                    <table style="width: 100%; border-collapse: collapse; border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; ">
                      <colgroup>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                      </colgroup>
                      <thead style="vertical-align: middle; ">
                        <tr>
                          <th style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; "> </th>
                          <th style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; ">
                            <span class="bold">
                              <strong>Interior</strong>
                            </span>
                          </th>
                          <th style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; ">
                            <span class="bold">
                              <strong>Boundary</strong>
                            </span>
                          </th>
                          <th style="vertical-align: middle; border-bottom: 1px solid ; ">
                            <span class="bold">
                              <strong>Exterior</strong>
                            </span>
                          </th>
                        </tr>
                      </thead>
                      <tbody style="vertical-align: middle; ">
                        <tr>
                          <td style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; ">
                                <span class="bold"><strong>Interior</strong></span>
                            </td>
                          <td style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im05.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( I(a) ∩ I(b) ) =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>2</strong>
                              </span>
                            </p>
                          </td>
                          <td style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im06.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( I(a) ∩ B(b)  =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>1</strong>
                              </span>
                            </p>
                          </td>
                          <td style="vertical-align: middle; border-bottom: 1px solid ; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im07.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( I(a) ∩ E(b) ) =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>2</strong>
                              </span>
                            </p>
                          </td>
                        </tr>
                        <tr>
                          <td style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; ">
                            <span class="bold">
                              <strong>Boundary</strong>
                            </span>
                          </td>
                          <td style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im08.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( B(a) ∩ I(b) ) =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>1</strong>
                              </span>
                            </p>
                          </td>
                          <td style="vertical-align: middle; border-right: 1px solid ; border-bottom: 1px solid ; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im09.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( B(a) ∩ B(b) ) =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>0</strong>
                              </span>
                            </p>
                          </td>
                          <td style="vertical-align: middle; border-bottom: 1px solid ; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im10.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( B(a) ∩ E(b) ) =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>1</strong>
                              </span>
                            </p>
                          </td>
                        </tr>
                        <tr>
                          <td style="vertical-align: middle; border-right: 1px solid ; ">
                            <span class="bold">
                              <strong>Exterior</strong>
                            </span>
                          </td>
                          <td style="vertical-align: middle; border-right: 1px solid ; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im11.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( E(a) ∩ I(b) ) =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>2</strong>
                              </span>
                            </p>
                          </td>
                          <td style="vertical-align: middle; border-right: 1px solid ; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im12.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( E(a) ∩ B(b) ) =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>1</strong>
                              </span>
                            </p>
                          </td>
                          <td style="vertical-align: middle; ">
                            <div class="informalfigure">
                              <div class="mediaobject">
                                <img src="../images/de9im13.png"/>
                              </div>
                            </div>
                            <p>
                              <span class="emphasis">
                                <em>dim( E(a) ∩ E(b)  =
                            </em>
                              </span>
                              <span class="bold">
                                <strong>2</strong>
                              </span>
                            </p>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p>Reading from left to right and top to bottom, the intersection matrix is
          represented as the text string '<span class="bold"><strong>212101212</strong></span>'.</p>
          <p>For more information, refer to:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist compact" style="list-style-type: disc; ">
              <li class="listitem">
                <p><a class="link" href="http://www.opengeospatial.org/standards/sfs" target="_top">OpenGIS Simple
          Features Implementation Specification for SQL</a> (version 1.1, section 2.1.13.2)</p>
              </li>
              <li class="listitem">
                <p>
                  <a class="link" href="https://en.wikipedia.org/wiki/DE-9IM" target="_top">Wikipedia: Dimensionally
              Extended Nine-Intersection Model (DE-9IM)</a>
                </p>
              </li>
              <li class="listitem">
                <p>
                  <a class="link" href="http://docs.geotools.org/latest/userguide/library/jts/dim9.html" target="_top">GeoTools: Point Set Theory and the DE-9IM Matrix</a>
                </p>
              </li>
            </ul>
          </div>
        </section>
        <section class="section" id="named-spatial-rel">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">5.1.2. Named Spatial Relationships</h3>
              </div>
            </div>
          </div>
          <p>To make it easy to determine common spatial relationships,
        the OGC SFS defines a set of <span class="emphasis"><em>named spatial relationship predicates</em></span>.
        PostGIS provides these as the functions
            <a class="xref" href="ST_Contains.html" title="ST_Contains">ST_Contains</a>,
            <a class="xref" href="ST_Crosses.html" title="ST_Crosses">ST_Crosses</a>, <a class="xref" href="ST_Disjoint.html" title="ST_Disjoint">ST_Disjoint</a>, <a class="xref" href="ST_Equals.html" title="ST_Equals">ST_Equals</a>,
            <a class="xref" href="ST_Intersects.html" title="ST_Intersects">ST_Intersects</a>, <a class="xref" href="ST_Overlaps.html" title="ST_Overlaps">ST_Overlaps</a>,
            <a class="xref" href="ST_Touches.html" title="ST_Touches">ST_Touches</a>, <a class="xref" href="ST_Within.html" title="ST_Within">ST_Within</a>.
        It also defines the non-standard relationship predicates
            <a class="xref" href="ST_Covers.html" title="ST_Covers">ST_Covers</a>, <a class="xref" href="ST_CoveredBy.html" title="ST_CoveredBy">ST_CoveredBy</a>,
            and <a class="xref" href="ST_ContainsProperly.html" title="ST_ContainsProperly">ST_ContainsProperly</a>.
        </p>
          <p>Spatial predicates are usually used as conditions in SQL <code class="code">WHERE</code> or <code class="code">JOIN</code> clauses.
        The named spatial predicates automatically use a spatial index if one is available,
        so there is no need to use the bounding box operator <code class="code">&amp;&amp;</code> as well.
        For example:
        </p>
          <pre class="programlisting">
SELECT city.name, state.name, city.geom
FROM city JOIN state ON ST_Intersects(city.geom, state.geom);
</pre>
          <p>For more details and illustrations, see the
        <a class="link" href="https://postgis.net/workshops/postgis-intro/spatial_relationships.html" target="_top">PostGIS Workshop.</a></p>
        </section>
        <section class="section" id="general-spatial-rel">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">5.1.3. General Spatial Relationships</h3>
              </div>
            </div>
          </div>
          <p>In some cases the named spatial relationships
        are insufficient to  provide a desired spatial filter condition.
        </p>
          <div class="informaltable">
            <table style="border: none;">
              <colgroup>
                <col/>
              </colgroup>
              <tbody>
                <tr>
                  <td><div style="float: right;" class="informalfigure-float"><div class="informalfigure"><div style="text-align: left; " class="mediaobject"><img style="text-align: left; " src="../images/de9im01.png"/></div></div></div><p>For example, consider a linear
                dataset representing a road network. It may be required
                to identify all road segments that cross
                each other, not at a point, but in a line (perhaps to validate some business rule).
                In this case <a class="xref" href="ST_Crosses.html" title="ST_Crosses">ST_Crosses</a> does not
                provide the necessary spatial filter, since for
                linear features it returns <code class="varname">true</code> only where they cross at a point.
                </p>
                <p>A two-step solution
                would be to first compute the actual intersection
                (<a class="xref" href="ST_Intersection.html" title="ST_Intersection">ST_Intersection</a>) of pairs of road lines that spatially
                intersect (<a class="xref" href="ST_Intersects.html" title="ST_Intersects">ST_Intersects</a>), and then check if the intersection's
                <a class="xref" href="ST_GeometryType.html" title="ST_GeometryType">ST_GeometryType</a> is '<code class="varname">LINESTRING</code>' (properly
                dealing with cases that return
                <code class="varname">GEOMETRYCOLLECTION</code>s of
                <code class="varname">[MULTI]POINT</code>s,
                <code class="varname">[MULTI]LINESTRING</code>s, etc.).</p>
                <p>Clearly, a simpler and faster solution is desirable.</p></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="informaltable">
            <table style="border: none;">
              <colgroup>
                <col/>
              </colgroup>
              <tbody>
                <tr>
                  <td><p> </p><div style="float: right;" class="informalfigure-float"><div class="informalfigure"><div style="text-align: right; " class="mediaobject"><img style="text-align: right; " src="../images/de9im02.png"/></div></div></div> <p>A second
                example is locating
                wharves that intersect a lake's boundary on a line and
                where one end of the wharf is up on shore. In other
                words, where a wharf is within but not completely contained by a
                lake, intersects the boundary of a lake on a line, and where
                exactly one of the wharf's endpoints is within or on the
                boundary of the lake. It is possible to use a
                combination of spatial predicates to find the required
                features:</p> <div class="itemizedlist"><ul style="list-style-type: disc; " class="itemizedlist"><li class="listitem"><p><a class="xref" href="ST_Contains.html" title="ST_Contains">ST_Contains</a>(lake, wharf) = TRUE</p></li><li class="listitem"><p><a class="xref" href="ST_ContainsProperly.html" title="ST_ContainsProperly">ST_ContainsProperly</a>(lake, wharf) = FALSE</p></li><li class="listitem"><p><a class="xref" href="ST_GeometryType.html" title="ST_GeometryType">ST_GeometryType</a>(<a class="xref" href="ST_Intersection.html" title="ST_Intersection">ST_Intersection</a>(wharf, lake)) =
                      'LINESTRING'</p></li><li class="listitem"><p><a class="xref" href="ST_NumGeometries.html" title="ST_NumGeometries">ST_NumGeometries</a>(<a class="xref" href="ST_Multi.html" title="ST_Multi">ST_Multi</a>(<a class="xref" href="ST_Intersection.html" title="ST_Intersection">ST_Intersection</a>(<a class="xref" href="ST_Boundary.html" title="ST_Boundary">ST_Boundary</a>(wharf),
                      <a class="xref" href="ST_Boundary.html" title="ST_Boundary">ST_Boundary</a>(lake)))) = 1</p><p>... but needless to say, this is quite complicated.</p></li></ul></div></td>
                </tr>
              </tbody>
            </table>
          </div>
          <p>These requirements can be met by computing the full DE-9IM intersection matrix.
          PostGIS provides the <a class="xref" href="ST_Relate.html" title="ST_Relate">ST_Relate</a> function
          to do this:
          </p>
          <pre class="programlisting">
SELECT ST_Relate( 'LINESTRING (1 1, 5 5)',
                  'POLYGON ((3 3, 3 7, 7 7, 7 3, 3 3))' );
st_relate
-----------
1010F0212
</pre>
          <p>To test a particular spatial relationship,
          an <span class="bold"><strong>intersection matrix pattern</strong></span> is used.
          This is the matrix representation augmented with the additional symbols
          <code class="literal">{T,*}</code>:
            </p>
          <div class="itemizedlist">
            <ul class="itemizedlist compact" style="list-style-type: disc; ">
              <li class="listitem">
                <p><code class="literal">T</code> =&gt;
              intersection dimension is non-empty; i.e. is in <code class="literal">{0,1,2}</code></p>
              </li>
              <li class="listitem">
                <p><code class="literal">*</code> =&gt; don't care</p>
              </li>
            </ul>
          </div>
          <p>Using intersection matrix patterns,
          specific spatial relationships can be evaluated in a more succinct way.
          The <a class="xref" href="ST_Relate.html" title="ST_Relate">ST_Relate</a> and the <a class="xref" href="ST_RelateMatch.html" title="ST_RelateMatch">ST_RelateMatch</a>
          functions can be used to test intersection matrix patterns.
          For the first example above, the intersection matrix pattern specifying
          two lines intersecting in a line is
          '<span class="bold"><strong>1*1***1**</strong></span>':</p>
          <pre class="programlisting">-- Find road segments that intersect in a line
SELECT a.id
FROM roads a, roads b
WHERE a.id != b.id
      AND a.geom &amp;&amp; b.geom
      AND ST_Relate(a.geom, b.geom, '1*1***1**');</pre>
          <p>For the second example, the intersection matrix pattern
          specifying a line partly inside and partly outside a polygon is
          '<span class="bold"><strong>102101FF2</strong></span>':</p>
          <pre class="programlisting">
-- Find wharves partly on a lake's shoreline
SELECT a.lake_id, b.wharf_id
FROM lakes a, wharfs b
WHERE a.geom &amp;&amp; b.geom
      AND ST_Relate(a.geom, b.geom, '102101FF2');
</pre>
        </section>
      </section>
      <section class="section" id="using-query-indexes">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both">5.2. Using Spatial Indexes</h2>
            </div>
          </div>
        </div>
        <p>When constructing queries using spatial conditions,
    for best performance it is important to
    ensure that a spatial index is used, if one exists (see <a class="xref" href="using_postgis_dbmanagement.html#build-indexes" title="4.9. Spatial Indexes">Section 4.9, “Spatial Indexes”</a>).
    To do this, a spatial operator or index-aware function must be used
    in a <code class="code">WHERE</code> or <code class="code">ON</code> clause of the query.
    </p>
        <p>Spatial operators include
    the bounding box operators
    (of which the most commonly used is <a class="xref" href="geometry_overlaps.html" title="&amp;&amp;">&amp;&amp;</a>;
    see <a class="xref" href="reference.html#operators-bbox" title="7.10.1. Bounding Box Operators">Section 7.10.1, “Bounding Box Operators”</a> for the full list)
    and the distance operators used in nearest-neighbor queries
    (the most common being <a class="xref" href="geometry_distance_knn.html" title="&lt;-&gt;">&lt;-&gt;</a>;
    see <a class="xref" href="reference.html#operators-distance" title="7.10.2. Distance Operators">Section 7.10.2, “Distance Operators”</a> for the full list.)
    </p>
        <p>Index-aware functions automatically add a bounding box operator
    to the spatial condition.
    Index-aware functions include the named spatial relationship predicates
    <a class="xref" href="ST_Contains.html" title="ST_Contains">ST_Contains</a>,
    <a class="xref" href="ST_ContainsProperly.html" title="ST_ContainsProperly">ST_ContainsProperly</a>,
    <a class="xref" href="ST_CoveredBy.html" title="ST_CoveredBy">ST_CoveredBy</a>,
    <a class="xref" href="ST_Covers.html" title="ST_Covers">ST_Covers</a>,
    <a class="xref" href="ST_Crosses.html" title="ST_Crosses">ST_Crosses</a>,
    <a class="xref" href="ST_Intersects.html" title="ST_Intersects">ST_Intersects</a>,
    <a class="xref" href="ST_Overlaps.html" title="ST_Overlaps">ST_Overlaps</a>,
    <a class="xref" href="ST_Touches.html" title="ST_Touches">ST_Touches</a>,
    <a class="xref" href="ST_Within.html" title="ST_Within">ST_Within</a>,
    <a class="xref" href="ST_Within.html" title="ST_Within">ST_Within</a>,
    and <a class="xref" href="ST_3DIntersects.html" title="ST_3DIntersects">ST_3DIntersects</a>,
    and the distance predicates
    <a class="xref" href="ST_DWithin.html" title="ST_DWithin">ST_DWithin</a>,
    <a class="xref" href="ST_DFullyWithin.html" title="ST_DFullyWithin">ST_DFullyWithin</a>,
    <a class="xref" href="ST_3DDFullyWithin.html" title="ST_3DDFullyWithin">ST_3DDFullyWithin</a>,
    and <a class="xref" href="ST_3DDWithin.html" title="ST_3DDWithin">ST_3DDWithin</a>
    .)
    </p>
        <p>Functions such as
    <a class="xref" href="ST_Distance.html" title="ST_Distance">ST_Distance</a> do <span class="emphasis"><em>not</em></span> use indexes to optimize their
    operation. For example, the following query would be quite slow on a
    large table:</p>
        <pre class="programlisting">
SELECT geom
FROM geom_table
WHERE ST_Distance( geom, 'SRID=312;POINT(100000 200000)' ) &lt; 100
</pre>
        <p>This query selects all the geometries in <code class="code">geom_table</code> which are
    within 100 units of the point (100000, 200000). It will be slow because
    it is calculating the distance between each point in the table and the
    specified point, ie. one <code class="varname">ST_Distance()</code> calculation
    is computed for <span class="bold"><strong>every</strong></span> row in the table.
    </p>
        <p>
    The number of rows processed can be reduced substantially by using the
	index-aware function <a class="xref" href="ST_DWithin.html" title="ST_DWithin">ST_DWithin</a>:</p>
        <pre class="programlisting">SELECT geom
FROM geom_table
WHERE ST_DWithin( geom, 'SRID=312;POINT(100000 200000)', 100 )
</pre>
        <p>This query selects the same geometries, but it does it in a more
    efficient way.
    This is enabled by <code class="varname">ST_DWithin()</code> using the
    <code class="varname">&amp;&amp;</code> operator internally on an expanded bounding box
    of the query geometry.
    If there is a spatial index on <code class="code">geom</code>, the query
    planner will recognize that it can use the index to reduce the number of
    rows scanned before calculating the distance.
    The spatial index allows retrieving only records with geometries
    whose bounding boxes overlap the expanded extent
    and hence which <span class="emphasis"><em>might</em></span> be within the required distance.
    The actual distance is then computed to confirm whether to include the record in the result set.
    </p>
        <p>For more information and examples see the
        <a class="link" href="https://postgis.net/workshops/postgis-intro/indexing.html" target="_top">PostGIS Workshop</a>.
    </p>
      </section>
      <section class="section" id="examples_spatial_sql">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both">5.3. Examples of Spatial SQL</h2>
            </div>
          </div>
        </div>
        <p>The examples in this section make use of a table
	  of linear roads, and a table of polygonal municipality boundaries. The
	  definition of the <code class="varname">bc_roads</code> table is:</p>
        <pre class="programlisting">Column    | Type              | Description
----------+-------------------+-------------------
gid       | integer           | Unique ID
name      | character varying | Road Name
geom      | geometry          | Location Geometry (Linestring)</pre>
        <p>The definition of the <code class="varname">bc_municipality</code>
	  table is:</p>
        <pre class="programlisting">Column   | Type              | Description
---------+-------------------+-------------------
gid      | integer           | Unique ID
code     | integer           | Unique ID
name     | character varying | City / Town Name
geom     | geometry          | Location Geometry (Polygon)</pre>
        <div class="qandaset" id="idm2906">
          <ul>
            <li>
              <a href="using_postgis_query.html#qa_total_length_roads">5.3.1. What is the total length of all roads, expressed in
			kilometers?</a>
            </li>
            <li>
              <a href="using_postgis_query.html#idm2913">5.3.2. How large is the city of Prince George, in hectares?</a>
            </li>
            <li>
              <a href="using_postgis_query.html#idm2919">5.3.3. What is the largest municipality in the province, by
			area?</a>
            </li>
            <li>
              <a href="using_postgis_query.html#idm2926">5.3.4. What is the length of roads fully contained within each
			municipality?</a>
            </li>
            <li>
              <a href="using_postgis_query.html#idm2933">5.3.5. Create a new table with all the roads within the city of
			Prince George.</a>
            </li>
            <li>
              <a href="using_postgis_query.html#idm2939">5.3.6. What is the length in kilometers of "Douglas St" in
			Victoria?</a>
            </li>
            <li>
              <a href="using_postgis_query.html#idm2944">5.3.7. What is the largest municipality polygon that has a
			hole?</a>
            </li>
          </ul>
          <table style="border: 0; width: 100%;">
            <colgroup>
              <col style="text-align: left; width: 1%; "/>
              <col/>
            </colgroup>
            <tbody>
              <tr class="question" id="qa_total_length_roads">
                <td style="text-align: left; vertical-align: top; " id="idm2908">
                  <p>
                    <strong>5.3.1.</strong>
                  </p>
                </td>
                <td style="text-align: left; vertical-align: top; ">
                  <p>What is the total length of all roads, expressed in
			kilometers?</p>
                </td>
              </tr>
              <tr class="answer">
                <td style="text-align: left; vertical-align: top; "/>
                <td style="text-align: left; vertical-align: top; ">
                  <p>You can answer this question with a very simple piece of
			SQL:</p>
                  <pre class="programlisting">SELECT sum(ST_Length(geom))/1000 AS km_roads FROM bc_roads;

km_roads
------------------
70842.1243039643
</pre>
                </td>
              </tr>
              <tr class="question" id="idm2913">
                <td style="text-align: left; vertical-align: top; " id="idm2914">
                  <p>
                    <strong>5.3.2.</strong>
                  </p>
                </td>
                <td style="text-align: left; vertical-align: top; ">
                  <p>How large is the city of Prince George, in hectares?</p>
                </td>
              </tr>
              <tr class="answer">
                <td style="text-align: left; vertical-align: top; "/>
                <td style="text-align: left; vertical-align: top; ">
                  <p>This query combines an attribute condition (on the
			municipality name) with a spatial calculation (of the
			polygon area):</p>
                  <pre class="programlisting">SELECT
  ST_Area(geom)/10000 AS hectares
FROM bc_municipality
WHERE name = 'PRINCE GEORGE';

hectares
------------------
32657.9103824927
</pre>
                </td>
              </tr>
              <tr class="question" id="idm2919">
                <td style="text-align: left; vertical-align: top; " id="idm2920">
                  <p>
                    <strong>5.3.3.</strong>
                  </p>
                </td>
                <td style="text-align: left; vertical-align: top; ">
                  <p>What is the largest municipality in the province, by
			area?</p>
                </td>
              </tr>
              <tr class="answer">
                <td style="text-align: left; vertical-align: top; "/>
                <td style="text-align: left; vertical-align: top; ">
                  <p>This query uses a spatial measurement as an ordering value.
            There are several ways of approaching this problem, but
			the most efficient is below:</p>
                  <pre class="programlisting">SELECT
  name,
  ST_Area(geom)/10000 AS hectares
FROM bc_municipality
ORDER BY hectares DESC
LIMIT 1;

name           | hectares
---------------+-----------------
TUMBLER RIDGE  | 155020.02556131
</pre>
                  <p>Note that in order to answer this query we have to calculate
			the area of every polygon. If we were doing this a lot it would
			make sense to add an area column to the table that could
			be indexed for performance. By ordering the results in a
			descending direction, and them using the PostgreSQL "LIMIT"
			command we can easily select just the largest value without using an
			aggregate function like MAX().</p>
                </td>
              </tr>
              <tr class="question" id="idm2926">
                <td style="text-align: left; vertical-align: top; " id="idm2927">
                  <p>
                    <strong>5.3.4.</strong>
                  </p>
                </td>
                <td style="text-align: left; vertical-align: top; ">
                  <p>What is the length of roads fully contained within each
			municipality?</p>
                </td>
              </tr>
              <tr class="answer">
                <td style="text-align: left; vertical-align: top; "/>
                <td style="text-align: left; vertical-align: top; ">
                  <p>This is an example of a "spatial join",
			which brings together data from two tables (with a join) using a
			spatial interaction ("contained") as the join condition
			(rather than the usual relational approach of joining on a common
			key):</p>
                  <pre class="programlisting">SELECT
  m.name,
  sum(ST_Length(r.geom))/1000 as roads_km
FROM bc_roads AS r
JOIN bc_municipality AS m
  ON ST_Contains(m.geom, r.geom)
GROUP BY m.name
ORDER BY roads_km;

name                        | roads_km
----------------------------+------------------
SURREY                      | 1539.47553551242
VANCOUVER                   | 1450.33093486576
LANGLEY DISTRICT            | 833.793392535662
BURNABY                     | 773.769091404338
PRINCE GEORGE               | 694.37554369147
...</pre>
                  <p>This query takes a while, because every road in the table is
			summarized into the final result (about 250K roads for the
			example table). For smaller datasets (several thousand
			records on several hundred) the response can be very fast.</p>
                </td>
              </tr>
              <tr class="question" id="idm2933">
                <td style="text-align: left; vertical-align: top; " id="idm2934">
                  <p>
                    <strong>5.3.5.</strong>
                  </p>
                </td>
                <td style="text-align: left; vertical-align: top; ">
                  <p>Create a new table with all the roads within the city of
			Prince George.</p>
                </td>
              </tr>
              <tr class="answer">
                <td style="text-align: left; vertical-align: top; "/>
                <td style="text-align: left; vertical-align: top; ">
                  <p>This is an example of an "overlay", which takes in two
			tables and outputs a new table that consists of spatially clipped
			or cut resultants. Unlike the "spatial join" demonstrated above,
			this query creates new geometries. An overlay is like a
			turbo-charged spatial join, and is useful for more exact analysis
			work:</p>
                  <pre class="programlisting">CREATE TABLE pg_roads as
SELECT
  ST_Intersection(r.geom, m.geom) AS intersection_geom,
  ST_Length(r.geom) AS rd_orig_length,
  r.*
FROM bc_roads AS r
JOIN bc_municipality AS m
  ON ST_Intersects(r.geom, m.geom)
WHERE
  m.name = 'PRINCE GEORGE';
</pre>
                </td>
              </tr>
              <tr class="question" id="idm2939">
                <td style="text-align: left; vertical-align: top; " id="idm2940">
                  <p>
                    <strong>5.3.6.</strong>
                  </p>
                </td>
                <td style="text-align: left; vertical-align: top; ">
                  <p>What is the length in kilometers of "Douglas St" in
			Victoria?</p>
                </td>
              </tr>
              <tr class="answer">
                <td style="text-align: left; vertical-align: top; "/>
                <td style="text-align: left; vertical-align: top; ">
                  <pre class="programlisting">SELECT
  sum(ST_Length(r.geom))/1000 AS kilometers
FROM bc_roads r
JOIN bc_municipality m
  ON ST_Intersects(m.geom, r.geom
WHERE
  r.name = 'Douglas St'
  AND m.name = 'VICTORIA';

kilometers
------------------
4.89151904172838
</pre>
                </td>
              </tr>
              <tr class="question" id="idm2944">
                <td style="text-align: left; vertical-align: top; " id="idm2945">
                  <p>
                    <strong>5.3.7.</strong>
                  </p>
                </td>
                <td style="text-align: left; vertical-align: top; ">
                  <p>What is the largest municipality polygon that has a
			hole?</p>
                </td>
              </tr>
              <tr class="answer">
                <td style="text-align: left; vertical-align: top; "/>
                <td style="text-align: left; vertical-align: top; ">
                  <pre class="programlisting">
SELECT gid, name, ST_Area(geom) AS area
FROM bc_municipality
WHERE ST_NRings(geom) &gt; 1
ORDER BY area DESC LIMIT 1;

gid  | name         | area
-----+--------------+------------------
12   | SPALLUMCHEEN | 257374619.430216

</pre>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>
    <footer>
      <div class="navfooter">
        <table style="width: 100%; ">
          <tr>
            <td style="width: 40%; text-align: left; "><a accesskey="p" href="using_postgis_dbmanagement.html">Prev</a> </td>
            <td style="width: 20%; text-align: center; "> </td>
            <td style="width: 40%; text-align: right; "> <a accesskey="n" href="performance_tips.html">Next</a></td>
          </tr>
          <tr>
            <td style="width: 40%; text-align: left; vertical-align: top; ">Chapter 4. Data Management </td>
            <td style="width: 20%; text-align: center; ">
              <a accesskey="h" href="index.html">Home</a>
            </td>
            <td style="width: 40%; text-align: right; vertical-align: top; "> Chapter 6. Performance Tips</td>
          </tr>
        </table>
      </div>
    </footer>
  </body>
</html>

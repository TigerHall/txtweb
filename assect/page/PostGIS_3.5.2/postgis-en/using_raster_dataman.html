<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Chapter 10. Raster Data Management, Queries, and Applications</title>
    <link rel="stylesheet" type="text/css" href="../style.css"/>
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.2"/>
    <link rel="prev" href="TG_Intersects.html" title="Intersects"/>
    <link rel="next" href="RT_reference.html" title="Chapter 11. Raster Reference"/>
  </head>
  <body>
    <header>
      <div class="navheader">
        <table style="width: 100%; ">
          <tr>
            <th style="text-align: center; " colspan="3">Chapter 10. Raster Data Management, Queries, and Applications</th>
          </tr>
          <tr>
            <td style="width: 20%; text-align: left; "><a accesskey="p" href="TG_Intersects.html">Prev</a> </td>
            <th style="width: 60%; text-align: center; "> </th>
            <td style="width: 20%; text-align: right; "> <a accesskey="n" href="RT_reference.html">Next</a></td>
          </tr>
        </table>
      </div>
    </header>
    <section class="chapter" id="using_raster_dataman">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title">Chapter 10. Raster Data Management, Queries, and Applications</h1>
          </div>
        </div>
      </div>
      <div class="toc">
        <div class="toc-title">Table of Contents</div>
        <ul class="toc">
          <li>
            <span class="section">
              <a href="using_raster_dataman.html#RT_Loading_Rasters">10.1. Loading and Creating Rasters</a>
            </span>
          </li>
          <li>
            <span class="section">
              <a href="using_raster_dataman.html#RT_Raster_Catalog">10.2. Raster Catalogs</a>
            </span>
          </li>
          <li>
            <span class="section">
              <a href="using_raster_dataman.html#RT_Raster_Applications">10.3. Building Custom Applications with PostGIS Raster</a>
            </span>
          </li>
        </ul>
      </div>
      <section class="section" id="RT_Loading_Rasters">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both">10.1. Loading and Creating Rasters</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <ul class="toc">
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_Raster_Loader">10.1.1. Using raster2pgsql to load rasters</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_Creating_Rasters">10.1.2. Creating rasters using PostGIS raster functions</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_Cloud_Rasters">10.1.3. Using "out db" cloud rasters</a>
              </span>
            </li>
          </ul>
        </div>
        <p>For most use cases, you will create PostGIS rasters by loading existing raster files using the packaged <code class="varname">raster2pgsql</code> raster loader.</p>
        <section class="section" id="RT_Raster_Loader">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.1.1. Using raster2pgsql to load rasters</h3>
              </div>
            </div>
          </div>
          <div class="toc">
            <ul class="toc">
              <li>
                <span class="section">
                  <a href="using_raster_dataman.html#idm26394">10.1.1.1. Example Usage</a>
                </span>
              </li>
              <li>
                <span class="section">
                  <a href="using_raster_dataman.html#idm26408">10.1.1.2. raster2pgsql options</a>
                </span>
              </li>
            </ul>
          </div>
          <p>The <code class="varname">raster2pgsql</code> is a raster loader executable that loads GDAL supported raster formats into SQL suitable for loading into a PostGIS raster table. It is capable of loading folders of raster files as well as creating overviews of rasters. </p>
          <p>Since the raster2pgsql is compiled as part of PostGIS most often (unless you compile your own GDAL library), the raster types supported by the executable will be the same as those compiled in the GDAL dependency library.  To get a list of raster types your particular <code class="varname">raster2pgsql</code> supports use the <code class="varname">-G</code> switch.</p>
          <div class="note">
            <table style="border: 0; ">
              <tr>
                <td style="text-align: center; vertical-align: top; width: 25px; " rowspan="2">
                  <img alt="[Note]" src="../images/note.png"/>
                </td>
                <th style="text-align: left; "/>
              </tr>
              <tr>
                <td style="text-align: left; vertical-align: top; ">
                  <p>When creating overviews of a specific factor from a set of rasters that are aligned, it is possible for the overviews to not align.  Visit <a class="link" href="http://trac.osgeo.org/postgis/ticket/1764" target="_top">http://trac.osgeo.org/postgis/ticket/1764</a> for an example where the overviews do not align.</p>
                </td>
              </tr>
            </table>
          </div>
          <section class="section" id="idm26394">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title">10.1.1.1. Example Usage</h4>
                </div>
              </div>
            </div>
            <p>An example session using the loader to create an input file and uploading it chunked in 100x100 tiles might look like this:</p>
            <pre class="programlisting">
# -s use srid 4326
# -I create spatial index
# -C use standard raster constraints
# -M vacuum analyze after load
# *.tif load all these files
# -F include a filename column in the raster table
# -t tile the output 100x100
# public.demelevation load into this table
raster2pgsql -s 4326 -I -C -M -F -t 100x100 *.tif public.demelevation &gt; elev.sql

# -d connect to this database
# -f read this file after connecting
psql -d gisdb -f elev.sql
</pre>
            <div class="note">
              <table style="border: 0; ">
                <tr>
                  <td style="text-align: center; vertical-align: top; width: 25px; " rowspan="2">
                    <img alt="[Note]" src="../images/note.png"/>
                  </td>
                  <th style="text-align: left; "/>
                </tr>
                <tr>
                  <td style="text-align: left; vertical-align: top; ">
                    <p>If you do not specify the schema as part of the target table name, the table will be created in the default schema of the database or user you are connecting with.</p>
                  </td>
                </tr>
              </table>
            </div>
            <p>A conversion and upload can be done all in one step using UNIX pipes:</p>
            <pre class="programlisting">raster2pgsql -s 4326 -I -C -M *.tif -F -t 100x100 public.demelevation | psql -d gisdb</pre>
            <p>Load rasters Massachusetts state plane meters aerial tiles
  into a schema called <code class="varname">aerial</code> and create a full view, 2 and 4 level overview tables, use copy mode for inserting (no intermediary file just straight to db), and -e don't force everything in a transaction (good if you want to see data in tables right away without waiting).  Break up the rasters into 128x128 pixel tiles and apply raster constraints. Use copy mode instead of table insert. (-F) Include a field called filename to hold the name of the file the tiles were cut from.</p>
            <pre class="programlisting">raster2pgsql -I -C -e -Y -F -s 26986 -t 128x128  -l 2,4 bostonaerials2008/*.jpg aerials.boston | psql -U postgres -d gisdb -h localhost -p 5432</pre>
            <pre class="programlisting">--get a list of raster types supported:
raster2pgsql -G</pre>
            <p>The -G commands outputs a list something like </p>
            <pre class="screen">
Available GDAL raster formats:
  Virtual Raster
  GeoTIFF
  National Imagery Transmission Format
  Raster Product Format TOC format
  ECRG TOC format
  Erdas Imagine Images (.img)
  CEOS SAR Image
  CEOS Image
  ...
  Arc/Info Export E00 GRID
  ZMap Plus Grid
  NOAA NGS Geoid Height Grids</pre>
          </section>
          <section class="section" id="idm26408">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title">10.1.1.2. raster2pgsql options</h4>
                </div>
              </div>
            </div>
            <div class="variablelist">
              <dl class="variablelist">
                <dt>
                  <span class="term">
                    <code class="option">-?</code>
                  </span>
                </dt>
                <dd>
                  <p>
              Display help screen.  Help will also display if you don't pass in any arguments.
            </p>
                </dd>
                <dt>
                  <span class="term">
                    <code class="option">-G</code>
                  </span>
                </dt>
                <dd>
                  <p>
             Print the supported raster formats.
            </p>
                </dd>
                <dt>
                  <span class="term">(c|a|d|p) These are mutually exclusive options:</span>
                </dt>
                <dd>
                  <p>
              </p>
                  <div class="variablelist">
                    <dl class="variablelist">
                      <dt>
                        <span class="term">
                          <code class="option">-c</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Create new table and populate it with raster(s), <span class="emphasis"><em>this is the default mode</em></span>
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-a</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Append raster(s) to an existing table.
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-d</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Drop table, create new one and populate it with raster(s)
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-p</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Prepare mode, only create the table.
                    </p>
                      </dd>
                    </dl>
                  </div>
                  <p>
            </p>
                </dd>
                <dt>
                  <span class="term">Raster processing: Applying constraints for proper registering in raster catalogs</span>
                </dt>
                <dd>
                  <p>
					</p>
                  <div class="variablelist">
                    <dl class="variablelist">
                      <dt>
                        <span class="term">
                          <code class="option">-C </code>
                        </span>
                      </dt>
                      <dd>
                        <p>
									Apply raster constraints -- srid, pixelsize etc. to ensure raster is properly registered in <code class="varname">raster_columns</code> view.
								</p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-x </code>
                        </span>
                      </dt>
                      <dd>
                        <p>
									Disable setting the max extent constraint.  Only applied if -C flag is also used.
								</p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-r</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
									Set the constraints (spatially unique and coverage tile) for regular blocking.  Only applied if -C flag is also used.
								</p>
                      </dd>
                    </dl>
                  </div>
                  <p>
				</p>
                </dd>
                <dt>
                  <span class="term">Raster processing: Optional parameters used to manipulate input raster dataset</span>
                </dt>
                <dd>
                  <p>
            </p>
                  <div class="variablelist">
                    <dl class="variablelist">
                      <dt>
                        <span class="term">
                          <code class="option">-s &lt;SRID&gt;</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                            Assign output raster with specified SRID.  If not provided or is zero, raster's metadata will be checked to determine an appropriate SRID.
                        </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-b BAND</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                           Index (1-based) of band to extract from raster.  For more than one band index, separate with comma (,).  If unspecified,
                           all bands of raster will be extracted.
                        </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-t TILE_SIZE</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                            Cut raster into tiles to be inserted one per table row.  <code class="varname">TILE_SIZE</code> is expressed as WIDTHxHEIGHT or set to the value "auto" to allow the loader to compute an appropriate tile size using the first raster and applied to all rasters.
                        </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-P</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                            Pad right-most and bottom-most tiles to guarantee that all tiles
                            have the same width and height.
                        </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-R, --register</code>
                        </span>
                      </dt>
                      <dd>
                        <p>Register the raster as a filesystem (out-db) raster.</p>
                        <p>Only the metadata of the raster and path location to the raster is stored in the database (not the pixels).</p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-l OVERVIEW_FACTOR</code>
                        </span>
                      </dt>
                      <dd>
                        <p>Create overview of the raster.  For more than
     one factor, separate with comma(,).  Overview table name follows
		 the pattern o_<code class="varname">overview factor</code>_<code class="varname">table</code>, where <code class="varname">overview factor</code> is a placeholder for numerical overview factor and <code class="varname">table</code> is replaced with the base table name.  Created overview is
     stored in the database and is not affected by -R. Note that your generated sql file will contain both the main table and overview tables.</p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-N NODATA</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
											NODATA value to use on bands without a NODATA value.
										</p>
                      </dd>
                    </dl>
                  </div>
                  <p>
            </p>
                </dd>
                <dt>
                  <span class="term">Optional parameters used to manipulate database objects</span>
                </dt>
                <dd>
                  <p>
              </p>
                  <div class="variablelist">
                    <dl class="variablelist">
                      <dt>
                        <span class="term">
                          <code class="option">-f COLUMN</code>
                        </span>
                      </dt>
                      <dd>
                        <p>Specify name of destination raster column, default is 'rast'
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-F</code>
                        </span>
                      </dt>
                      <dd>
                        <p>Add a column with the name of the file</p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-n COLUMN</code>
                        </span>
                      </dt>
                      <dd>
                        <p>Specify the name of the filename column. Implies -F.</p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-q</code>
                        </span>
                      </dt>
                      <dd>
                        <p>Wrap PostgreSQL identifiers in quotes.</p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-I</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Create a GiST index on the raster column.
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-M</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Vacuum analyze the raster table.
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-k</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                        Keeps empty tiles and skips NODATA value checks for each raster band.
                        Note you save time in checking, but could end up with far more junk rows in your database and those junk rows are not marked as empty tiles.
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-T tablespace</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Specify the tablespace for the new table.
     Note that indices (including the primary key) will still use
     the default tablespace unless the -X flag is also used.
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-X tablespace</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Specify the tablespace for the table's new index.
     This applies to the primary key and the spatial index if the
     -I flag is used.
                    </p>
                      </dd>
                      <dt>
                        <span class="term">
                          <code class="option">-Y  max_rows_per_copy=50</code>
                        </span>
                      </dt>
                      <dd>
                        <p>
                      Use copy statements instead of insert statements.  Optionally specify <code class="varname">max_rows_per_copy</code>;
                      default 50 when not specified.</p>
                      </dd>
                    </dl>
                  </div>
                  <p>
            </p>
                </dd>
                <dt>
                  <span class="term">
                    <code class="option">-e</code>
                  </span>
                </dt>
                <dd>
                  <p>Execute each statement individually, do not use a transaction.</p>
                </dd>
                <dt>
                  <span class="term">
                    <code class="option">-E ENDIAN</code>
                  </span>
                </dt>
                <dd>
                  <p>Control endianness of generated binary output of raster; specify 0 for XDR and 1 for NDR (default); only NDR output is supported now</p>
                </dd>
                <dt>
                  <span class="term">
                    <code class="option">-V version</code>
                  </span>
                </dt>
                <dd>
                  <p>Specify version of output format.  Default  is 0.  Only 0 is supported at this time.</p>
                </dd>
              </dl>
            </div>
          </section>
        </section>
        <section class="section" id="RT_Creating_Rasters">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.1.2. Creating rasters using PostGIS raster functions</h3>
              </div>
            </div>
          </div>
          <p>On many occasions, you'll want to create rasters and raster tables right in the database.  There are a plethora of functions to do that.  The general steps to follow.</p>
          <div class="orderedlist">
            <ol class="orderedlist" type="1">
              <li class="listitem">
                <p>Create a table with a raster column to hold the new raster records which can be accomplished with:</p>
                <pre class="programlisting">CREATE TABLE myrasters(rid serial primary key, rast raster);</pre>
              </li>
              <li class="listitem">
                <p>There are many functions to help with that goal.  If you are creating rasters not as a derivative of other rasters, you will want to start with:
				<a class="xref" href="RT_ST_MakeEmptyRaster.html" title="ST_MakeEmptyRaster">ST_MakeEmptyRaster</a>, followed by <a class="xref" href="RT_ST_AddBand.html" title="ST_AddBand">ST_AddBand</a></p>
                <p>You can also create rasters from geometries.  To achieve that you'll want to use <a class="xref" href="RT_ST_AsRaster.html" title="ST_AsRaster">ST_AsRaster</a> perhaps accompanied with
			other functions such as <a class="xref" href="RT_ST_Union.html" title="ST_Union">ST_Union</a> or <a class="xref" href="RT_ST_MapAlgebraFct2.html" title="ST_MapAlgebraFct">ST_MapAlgebraFct</a> or any of the family of other map algebra functions.</p>
                <p>There are even many more options for creating new raster tables from existing tables.  For example you can create a raster table in a different projection from an existing one using <a class="xref" href="RT_ST_Transform.html" title="ST_Transform">ST_Transform</a> </p>
              </li>
              <li class="listitem">
                <p>Once you are done populating your table initially, you'll want to create a spatial index on the raster column with something like:</p>
                <pre class="programlisting">CREATE INDEX myrasters_rast_st_convexhull_idx ON myrasters USING gist( ST_ConvexHull(rast) );</pre>
                <p>Note the use of <a class="xref" href="RT_ST_ConvexHull.html" title="ST_ConvexHull">ST_ConvexHull</a> since most raster operators are based on the convex hull of the rasters.</p>
                <div class="note">
                  <table style="border: 0; ">
                    <tr>
                      <td style="text-align: center; vertical-align: top; width: 25px; " rowspan="2">
                        <img alt="[Note]" src="../images/note.png"/>
                      </td>
                      <th style="text-align: left; "/>
                    </tr>
                    <tr>
                      <td style="text-align: left; vertical-align: top; ">
                        <p>Pre-2.0 versions of PostGIS raster were based on the envelop rather than the convex hull.  For the spatial indexes to work properly you'll need to drop those and replace with convex hull based index.</p>
                      </td>
                    </tr>
                  </table>
                </div>
              </li>
              <li class="listitem">
                <p>Apply raster constraints using <a class="xref" href="RT_AddRasterConstraints.html" title="AddRasterConstraints">AddRasterConstraints</a></p>
              </li>
            </ol>
          </div>
        </section>
        <section class="section" id="RT_Cloud_Rasters">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.1.3. Using "out db" cloud rasters</h3>
              </div>
            </div>
          </div>
          <p>
        The <code class="varname">raster2pgsql</code> tool uses GDAL to access raster data, and can take advantage of a key GDAL feature: the ability to read
        from rasters that are <a class="link" href="https://gdal.org/user/virtual_file_systems.html#network-based-file-systems" target="_top">stored remotely</a> in cloud "object stores" (e.g. AWS S3, Google Cloud Storage).
    </p>
          <p>
        Efficient use of cloud stored rasters requires the use of a "cloud optimized" format. The most well-known and widely used is the "<a class="link" href="https://gdal.org/drivers/raster/cog.html" target="_top">cloud optimized GeoTIFF</a>" format. Using a non-cloud format, like a JPEG, or an un-tiled TIFF will result in very poor performance, as the system will have to download the entire raster each time it needs to access a subset.
    </p>
          <p>
        First, load your raster into the cloud storage of your choice. Once it is loaded, you will have a URI to access it with, either an "http" URI, or sometimes a URI specific to the service. (e.g., "s3://bucket/object"). To access non-public buckets, you will need to supply GDAL config options to authenticate your connection. Note that this command is <span class="emphasis"><em>reading</em></span> from the cloud raster and <span class="emphasis"><em>writing</em></span> to the database.
    </p>
          <pre class="programlisting">AWS_ACCESS_KEY_ID=xxxxxxxxxxxxxxxxxxxx \
AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx \
raster2pgsql \
  -s 990000 \
  -t 256x256 \
  -I \
  -R \
  /vsis3/your.bucket.com/your_file.tif \
  your_table \
  | psql your_db</pre>
          <p>
        Once the table is loaded, you need to give the database permission to read from remote rasters, by setting two permissions, <a class="xref" href="postgis_enable_outdb_rasters.html" title="postgis.enable_outdb_rasters">postgis.enable_outdb_rasters</a> and <a class="xref" href="postgis_gdal_enabled_drivers.html" title="postgis.gdal_enabled_drivers">postgis.gdal_enabled_drivers</a>.
    </p>
          <pre class="programlisting">SET postgis.enable_outdb_rasters = true;
SET postgis.gdal_enabled_drivers TO 'ENABLE_ALL';
    </pre>
          <p>
        To make the changes sticky, set them directly on your database. You will need to re-connect to experience the new settings.
    </p>
          <pre class="programlisting">ALTER DATABASE your_db SET postgis.enable_outdb_rasters = true;
ALTER DATABASE your_db SET postgis.gdal_enabled_drivers TO 'ENABLE_ALL';
    </pre>
          <p>
        For non-public rasters, you may have to provide access keys to read from the cloud rasters. The same keys you used to write the <code class="varname">raster2pgsql</code> call can be set for use inside the database, with the <a class="xref" href="postgis_gdal_vsi_options.html" title="postgis.gdal_vsi_options">postgis.gdal_vsi_options</a> configuration. Note that multiple options can be set by space-separating the <code class="varname">key=value</code> pairs.
    </p>
          <pre class="programlisting">SET postgis.gdal_vsi_options = 'AWS_ACCESS_KEY_ID=xxxxxxxxxxxxxxxxxxxx
AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';</pre>
          <p>
        Once you have the data loaded and permissions set you can interact with the raster table like any other raster table, using the same functions. The database will handle all the mechanics of connecting to the cloud data when it needs to read pixel data.
    </p>
        </section>
      </section>
      <section class="section" id="RT_Raster_Catalog">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both">10.2. Raster Catalogs</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <ul class="toc">
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_Raster_Columns">10.2.1. Raster Columns Catalog</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_Raster_Overviews">10.2.2. Raster Overviews</a>
              </span>
            </li>
          </ul>
        </div>
        <p>There are two raster catalog views that come packaged with PostGIS.  Both views utilize information embedded in the constraints of the raster tables.  As a result
		the catalog views are always consistent with the raster data in the tables since the constraints are enforced. </p>
        <div class="orderedlist">
          <ol class="orderedlist" type="1">
            <li class="listitem">
              <p><code class="varname">raster_columns</code> this view catalogs all the raster table columns in your database.</p>
            </li>
            <li class="listitem">
              <p><code class="varname">raster_overviews</code> this view catalogs all the raster table columns in your database that serve as overviews for a finer grained table.  Tables of this type are generated when you use the <code class="varname">-l</code> switch during load.</p>
            </li>
          </ol>
        </div>
        <section class="section" id="RT_Raster_Columns">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.2.1. Raster Columns Catalog</h3>
              </div>
            </div>
          </div>
          <p>The <code class="varname">raster_columns</code> is a catalog of all raster table columns in your database that are of type raster.  It is a view utilizing the constraints on the tables
	so the information is always consistent even if you restore one raster table from a backup of another database.  The following columns exist in the <code class="varname">raster_columns</code> catalog.</p>
          <p>If you created your tables not with the loader or forgot to specify the <code class="varname">-C</code> flag during load, you can enforce the constraints after the
	fact using <a class="xref" href="RT_AddRasterConstraints.html" title="AddRasterConstraints">AddRasterConstraints</a> so that the <code class="varname">raster_columns</code> catalog registers the common information about your raster tiles.</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p><code class="varname">r_table_catalog</code> The database the table is in.  This will always read the current database.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">r_table_schema</code> The database schema the raster table belongs to.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">r_table_name</code> raster table</p>
              </li>
              <li class="listitem">
                <p><code class="varname">r_raster_column</code> the column in the <code class="varname">r_table_name</code> table that is of type raster.  There is nothing in PostGIS preventing you from having multiple raster columns per table so its possible to have a raster table listed multiple times with a different raster column for each.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">srid</code> The spatial reference identifier of the raster.  Should be an entry in the <a class="xref" href="using_postgis_dbmanagement.html#spatial_ref_sys" title="4.5. Spatial Reference Systems">Section 4.5, “Spatial Reference Systems”</a>.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">scale_x</code> The scaling between geometric spatial coordinates and pixel.  This is only available if all tiles in the raster column have the same <code class="varname">scale_x</code> and this constraint is applied. Refer to <a class="xref" href="RT_ST_ScaleX.html" title="ST_ScaleX">ST_ScaleX</a> for more details.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">scale_y</code> The scaling between geometric spatial coordinates and pixel.  This is only available if all tiles in the raster column have the same <code class="varname">scale_y</code> and the <code class="varname">scale_y</code> constraint is applied. Refer to <a class="xref" href="RT_ST_ScaleY.html" title="ST_ScaleY">ST_ScaleY</a> for more details.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">blocksize_x</code> The width (number of pixels across) of each raster tile . Refer to <a class="xref" href="RT_ST_Width.html" title="ST_Width">ST_Width</a> for more details.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">blocksize_y</code> The width (number of pixels down) of each raster tile . Refer to <a class="xref" href="RT_ST_Height.html" title="ST_Height">ST_Height</a> for more details.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">same_alignment</code> A boolean that is true if all the raster tiles have the same alignment . Refer to <a class="xref" href="RT_ST_SameAlignment.html" title="ST_SameAlignment">ST_SameAlignment</a> for more details.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">regular_blocking</code> If the raster column has the spatially unique and coverage tile constraints, the value with be TRUE.  Otherwise, it will be FALSE.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">num_bands</code> The number of bands in each tile of your raster set.  This is the same information as what is provided by <a class="xref" href="RT_ST_NumBands.html" title="ST_NumBands">ST_NumBands</a></p>
              </li>
              <li class="listitem">
                <p><code class="varname">pixel_types</code> An array defining the pixel type for each band.  You will have the same number of elements in this array as you have number of bands.  The pixel_types are one of the following defined in <a class="xref" href="RT_ST_BandPixelType.html" title="ST_BandPixelType">ST_BandPixelType</a>.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">nodata_values</code> An array of double precision numbers denoting the <code class="varname">nodata_value</code> for each band.  You will have the same number of elements in this array as you have number of bands. These numbers define the pixel value for each band that should be ignored for most operations.  This is similar information provided by <a class="xref" href="RT_ST_BandNoDataValue.html" title="ST_BandNoDataValue">ST_BandNoDataValue</a>.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">out_db</code> An array of boolean flags indicating if the raster bands data is maintained outside the database. You will have the same number of elements in this array as you have number of bands.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">extent</code> This is the extent of all the raster rows in your raster set. If you plan to load more data that will change the extent of the set, you'll want to run the <a class="xref" href="RT_DropRasterConstraints.html" title="DropRasterConstraints">DropRasterConstraints</a> function before load and then reapply constraints with <a class="xref" href="RT_AddRasterConstraints.html" title="AddRasterConstraints">AddRasterConstraints</a> after load. </p>
              </li>
              <li class="listitem">
                <p><code class="varname">spatial_index</code> A boolean that is true if raster column has a spatial index.</p>
              </li>
            </ul>
          </div>
        </section>
        <section class="section" id="RT_Raster_Overviews">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.2.2. Raster Overviews</h3>
              </div>
            </div>
          </div>
          <p><code class="varname">raster_overviews</code> catalogs information about raster table columns used for overviews and additional information about them that is useful to know when utilizing overviews. Overview tables are cataloged in both <code class="varname">raster_columns</code> and <code class="varname">raster_overviews</code> because they are rasters in their own right but also serve an additional special purpose of being a lower resolution caricature of a higher resolution table. These are generated along-side the main raster table when you use the <code class="varname">-l</code> switch in raster loading or can be generated manually using <a class="xref" href="RT_AddOverviewConstraints.html" title="AddOverviewConstraints">AddOverviewConstraints</a>.</p>
          <p>Overview tables contain the same constraints as other raster tables as well as additional informational only constraints specific to overviews.</p>
          <div class="note">
            <table style="border: 0; ">
              <tr>
                <td style="text-align: center; vertical-align: top; width: 25px; " rowspan="2">
                  <img alt="[Note]" src="../images/note.png"/>
                </td>
                <th style="text-align: left; "/>
              </tr>
              <tr>
                <td style="text-align: left; vertical-align: top; ">
                  <p>The information in <code class="varname">raster_overviews</code> does not duplicate the information in <code class="varname">raster_columns</code>.  If you need the information about an overview table present in <code class="varname">raster_columns</code> you can join the <code class="varname">raster_overviews</code> and <code class="varname">raster_columns</code> together to get the full set of information you need.</p>
                </td>
              </tr>
            </table>
          </div>
          <p>Two main reasons for overviews are:</p>
          <div class="orderedlist">
            <ol class="orderedlist" type="1">
              <li class="listitem">
                <p>Low resolution representation of the core tables commonly used for fast mapping zoom-out.</p>
              </li>
              <li class="listitem">
                <p>Computations are generally faster to do on them than their higher resolution parents because there are fewer records and each pixel covers more territory.  Though the computations are not as accurate as the high-res tables they support, they can be sufficient in many rule-of-thumb computations.</p>
              </li>
            </ol>
          </div>
          <p>The <code class="varname">raster_overviews</code> catalog contains the following columns of information.</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p><code class="varname">o_table_catalog</code> The database the overview table is in.  This will always read the current database.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">o_table_schema</code> The database schema the overview raster table belongs to.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">o_table_name</code> raster overview table name</p>
              </li>
              <li class="listitem">
                <p><code class="varname">o_raster_column</code> the raster column in the overview table.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">r_table_catalog</code> The database the raster table that this overview services is in.  This will always read the current database.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">r_table_schema</code> The database schema the raster table that this overview services belongs to.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">r_table_name</code> raster table that this overview services.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">r_raster_column</code> the raster column that this overview column services.</p>
              </li>
              <li class="listitem">
                <p><code class="varname">overview_factor</code> - this is the pyramid level of the overview table.  The higher the number the lower the resolution of the table.
					raster2pgsql if given a folder of images, will compute overview of each image file and load separately.  Level 1 is assumed and always the original file. Level 2 is
					will have each tile represent 4 of the original.  So for example if you have a folder of 5000x5000 pixel image files that you chose to chunk 125x125, for each image file your base table will
						have (5000*5000)/(125*125) records = 1600, your (l=2) <code class="varname">o_2</code> table will have ceiling(1600/Power(2,2)) = 400 rows, your (l=3) <code class="varname">o_3</code> will have ceiling(1600/Power(2,3) ) = 200 rows.
						If your pixels aren't divisible by the size of your tiles, you'll get some scrap tiles (tiles not completely filled).  Note that each overview tile generated by raster2pgsql has the same number of
						pixels as its parent, but is of a lower resolution where each pixel of it represents (Power(2,overview_factor) pixels of the original).</p>
              </li>
            </ul>
          </div>
        </section>
      </section>
      <section class="section" id="RT_Raster_Applications">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both">10.3. Building Custom Applications with PostGIS Raster</h2>
            </div>
          </div>
        </div>
        <div class="toc">
          <ul class="toc">
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_PHP_Output">10.3.1. PHP Example Outputting using ST_AsPNG in concert with other raster functions</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_Net_Output_CS">10.3.2. ASP.NET C# Example Outputting using ST_AsPNG in concert with other raster functions</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_Java_Console_App">10.3.3. Java console app that outputs raster query as Image file</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RT_PLPython">10.3.4. Use PLPython to dump out images via SQL</a>
              </span>
            </li>
            <li>
              <span class="section">
                <a href="using_raster_dataman.html#RasterOutput_PSQL">10.3.5. Outputting Rasters with PSQL</a>
              </span>
            </li>
          </ul>
        </div>
        <p>The fact that PostGIS raster provides you with SQL functions to render rasters in known image formats gives  you a lot of options for rendering them.
		For example you can use OpenOffice / LibreOffice for rendering as demonstrated in <a class="link" href="http://www.postgresonline.com/journal/archives/244-Rendering-PostGIS-Raster-graphics-with-LibreOffice-Base-Reports.html" target="_top">Rendering PostGIS Raster graphics with LibreOffice Base Reports</a>.  In addition you can use a wide variety of languages as demonstrated in this section.</p>
        <section class="section" id="RT_PHP_Output">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.3.1. PHP Example Outputting using ST_AsPNG in concert with other raster functions</h3>
              </div>
            </div>
          </div>
          <p>In this section, we'll demonstrate how to use the PHP PostgreSQL driver and the <a class="xref" href="RT_ST_AsGDALRaster.html" title="ST_AsGDALRaster">ST_AsGDALRaster</a> family of functions to
				output band 1,2,3 of a raster to a PHP request stream that can then be embedded in an img src html tag.</p>
          <p>The sample query demonstrates how to combine a whole bunch of raster functions together to grab all tiles that intersect
				a particular wgs 84 bounding box and then unions with <a class="xref" href="RT_ST_Union.html" title="ST_Union">ST_Union</a> the intersecting tiles together returning all bands, transforms to user specified projection using <a class="xref" href="RT_ST_Transform.html" title="ST_Transform">ST_Transform</a>,
				and then outputs the results as a png using <a class="xref" href="RT_ST_AsPNG.html" title="ST_AsPNG">ST_AsPNG</a>.</p>
          <p>You would call the below using </p>
          <pre class="programlisting">http://mywebserver/test_raster.php?srid=2249</pre>
          <p> to get the raster image in Massachusetts state plane feet.</p>
          <pre class="programlisting">

&lt;?php
/** contents of test_raster.php **/
$conn_str ='dbname=mydb host=localhost port=5432 user=myuser password=mypwd';
$dbconn = pg_connect($conn_str);
header('Content-Type: image/png');
/**If a particular projection was requested use it otherwise use mass state plane meters **/
if (!empty( $_REQUEST['srid'] ) &amp;amp;&amp;amp; is_numeric( $_REQUEST['srid']) ){
		$input_srid = intval($_REQUEST['srid']);
}
else { $input_srid = 26986; }
/** The set bytea_output may be needed for PostgreSQL 9.0+, but not for 8.4 **/
$sql = "set bytea_output='escape';
SELECT ST_AsPNG(ST_Transform(
			ST_AddBand(ST_Union(rast,1), ARRAY[ST_Union(rast,2),ST_Union(rast,3)])
				,$input_srid) ) As new_rast
 FROM aerials.boston
	WHERE
	 ST_Intersects(rast, ST_Transform(ST_MakeEnvelope(-71.1217, 42.227, -71.1210, 42.218,4326),26986) )";
$result = pg_query($sql);
$row = pg_fetch_row($result);
pg_free_result($result);
if ($row === false) return;
echo pg_unescape_bytea($row[0]);
?&gt;
</pre>
        </section>
        <section class="section" id="RT_Net_Output_CS">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.3.2. ASP.NET C# Example Outputting using ST_AsPNG in concert with other raster functions</h3>
              </div>
            </div>
          </div>
          <p>In this section, we'll demonstrate how to use Npgsql PostgreSQL .NET driver and the <a class="xref" href="RT_ST_AsGDALRaster.html" title="ST_AsGDALRaster">ST_AsGDALRaster</a> family of functions to
				output band 1,2,3 of a raster to a PHP request stream that can then be embedded in an img src html tag.</p>
          <p>You will need the npgsql .NET PostgreSQL driver for this exercise which you can get the latest of from <a class="link" href="http://npgsql.projects.postgresql.org/" target="_top">http://npgsql.projects.postgresql.org/</a>.  Just download the latest and drop into your ASP.NET bin folder and you'll be good to go.</p>
          <p>The sample query demonstrates how to combine a whole bunch of raster functions together to grab all tiles that intersect
				a particular wgs 84 bounding box and then unions with <a class="xref" href="RT_ST_Union.html" title="ST_Union">ST_Union</a> the intersecting tiles together returning all bands, transforms to user specified projection using <a class="xref" href="RT_ST_Transform.html" title="ST_Transform">ST_Transform</a>,
				and then outputs the results as a png using <a class="xref" href="RT_ST_AsPNG.html" title="ST_AsPNG">ST_AsPNG</a>.</p>
          <p>This is same example as <a class="xref" href="using_raster_dataman.html#RT_PHP_Output" title="10.3.1. PHP Example Outputting using ST_AsPNG in concert with other raster functions">Section 10.3.1, “PHP Example Outputting using ST_AsPNG in concert with other raster functions”</a> except implemented in C#.</p>
          <p>You would call the below using </p>
          <pre class="programlisting">http://mywebserver/TestRaster.ashx?srid=2249</pre>
          <p> to get the raster image in Massachusetts state plane feet.</p>
          <pre class="programlisting">
 -- web.config connection string section --
&lt;connectionStrings&gt;
    &lt;add name="DSN"
        connectionString="server=localhost;database=mydb;Port=5432;User Id=myuser;password=mypwd"/&gt;
&lt;/connectionStrings&gt;
</pre>
          <pre class="programlisting">
// Code for TestRaster.ashx
&lt;%@ WebHandler Language="C#" Class="TestRaster" %&gt;
using System;
using System.Data;
using System.Web;
using Npgsql;

public class TestRaster : IHttpHandler
{
	public void ProcessRequest(HttpContext context)
	{

		context.Response.ContentType = "image/png";
		context.Response.BinaryWrite(GetResults(context));

	}

	public bool IsReusable {
		get { return false; }
	}

	public byte[] GetResults(HttpContext context)
	{
		byte[] result = null;
		NpgsqlCommand command;
		string sql = null;
		int input_srid = 26986;
        try {
		    using (NpgsqlConnection conn = new NpgsqlConnection(System.Configuration.ConfigurationManager.ConnectionStrings["DSN"].ConnectionString)) {
			    conn.Open();

                if (context.Request["srid"] != null)
                {
                    input_srid = Convert.ToInt32(context.Request["srid"]);
                }
                sql = @"SELECT ST_AsPNG(
                            ST_Transform(
			                ST_AddBand(
                                ST_Union(rast,1), ARRAY[ST_Union(rast,2),ST_Union(rast,3)])
				                    ,:input_srid) ) As new_rast
                        FROM aerials.boston
	                        WHERE
	                            ST_Intersects(rast,
                                    ST_Transform(ST_MakeEnvelope(-71.1217, 42.227, -71.1210, 42.218,4326),26986) )";
			    command = new NpgsqlCommand(sql, conn);
                command.Parameters.Add(new NpgsqlParameter("input_srid", input_srid));


			    result = (byte[]) command.ExecuteScalar();
                conn.Close();
			}

		}
        catch (Exception ex)
        {
            result = null;
            context.Response.Write(ex.Message.Trim());
        }
		return result;
	}
}
</pre>
        </section>
        <section class="section" id="RT_Java_Console_App">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.3.3. Java console app that outputs raster query as Image file</h3>
              </div>
            </div>
          </div>
          <p>This is a simple java console app that takes a query that returns one image and outputs to specified file.</p>
          <p>You can download the latest PostgreSQL JDBC drivers from <a class="link" href="http://jdbc.postgresql.org/download.html" target="_top">http://jdbc.postgresql.org/download.html</a> </p>
          <p>You can compile the following code using a command something like:</p>
          <pre class="programlisting">set env CLASSPATH .:..\postgresql-9.0-801.jdbc4.jar
javac SaveQueryImage.java
jar cfm SaveQueryImage.jar Manifest.txt *.class</pre>
          <p>And call it from the command-line with something like</p>
          <pre class="programlisting">java -jar SaveQueryImage.jar "SELECT ST_AsPNG(ST_AsRaster(ST_Buffer(ST_Point(1,5),10, 'quad_segs=2'),150, 150, '8BUI',100));" "test.png" </pre>
          <pre class="programlisting"> -- Manifest.txt --
Class-Path: postgresql-9.0-801.jdbc4.jar
Main-Class: SaveQueryImage</pre>
          <pre class="programlisting">// Code for SaveQueryImage.java
import java.sql.Connection;
import java.sql.SQLException;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.io.*;

public class SaveQueryImage {
  public static void main(String[] argv) {
      System.out.println("Checking if Driver is registered with DriverManager.");

      try {
        //java.sql.DriverManager.registerDriver (new org.postgresql.Driver());
        Class.forName("org.postgresql.Driver");
      }
      catch (ClassNotFoundException cnfe) {
        System.out.println("Couldn't find the driver!");
        cnfe.printStackTrace();
        System.exit(1);
      }

      Connection conn = null;

      try {
        conn = DriverManager.getConnection("jdbc:postgresql://localhost:5432/mydb","myuser", "mypwd");
        conn.setAutoCommit(false);

        PreparedStatement sGetImg = conn.prepareStatement(argv[0]);

        ResultSet rs = sGetImg.executeQuery();

		FileOutputStream fout;
		try
		{
			rs.next();
			/** Output to file name requested by user **/
			fout = new FileOutputStream(new File(argv[1]) );
			fout.write(rs.getBytes(1));
			fout.close();
		}
		catch(Exception e)
		{
			System.out.println("Can't create file");
			e.printStackTrace();
		}

        rs.close();
		sGetImg.close();
        conn.close();
      }
      catch (SQLException se) {
        System.out.println("Couldn't connect: print out a stack trace and exit.");
        se.printStackTrace();
        System.exit(1);
      }
  }
}</pre>
        </section>
        <section class="section" id="RT_PLPython">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.3.4. Use PLPython to dump out images via SQL</h3>
              </div>
            </div>
          </div>
          <p>This is a plpython stored function that creates a file in the server directory for each record.
			Requires you have plpython installed.  Should work fine with both plpythonu and plpython3u.</p>
          <pre class="programlisting">CREATE OR REPLACE FUNCTION write_file (param_bytes bytea, param_filepath text)
RETURNS text
AS $$
f = open(param_filepath, 'wb+')
f.write(param_bytes)
return param_filepath
$$ LANGUAGE plpythonu;</pre>
          <pre class="programlisting">--write out 5 images to the PostgreSQL server in varying sizes
-- note the postgresql daemon account needs to have write access to folder
-- this echos back the file names created;
 SELECT write_file(ST_AsPNG(
	ST_AsRaster(ST_Buffer(ST_Point(1,5),j*5, 'quad_segs=2'),150*j, 150*j, '8BUI',100)),
	 'C:/temp/slices'|| j || '.png')
	 FROM generate_series(1,5) As j;

     write_file
---------------------
 C:/temp/slices1.png
 C:/temp/slices2.png
 C:/temp/slices3.png
 C:/temp/slices4.png
 C:/temp/slices5.png
</pre>
        </section>
        <section class="section" id="RasterOutput_PSQL">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title">10.3.5. Outputting Rasters with PSQL</h3>
              </div>
            </div>
          </div>
          <p>Sadly PSQL doesn't have easy to use built-in functionality for outputting binaries.  This is a bit of a hack that piggy backs on PostgreSQL somewhat legacy large object support.  To use first launch your psql commandline connected to your database.
			</p>
          <p>Unlike the python approach, this approach creates the file on your local computer.</p>
          <pre class="screen">SELECT oid, lowrite(lo_open(oid, 131072), png) As num_bytes
 FROM
 ( VALUES (lo_create(0),
   ST_AsPNG( (SELECT rast FROM aerials.boston WHERE rid=1) )
  ) ) As v(oid,png);
-- you'll get an output something like --
   oid   | num_bytes
---------+-----------
 2630819 |     74860

-- next note the oid and do this replacing the c:/test.png to file path location
-- on your local computer
 \lo_export 2630819 'C:/temp/aerial_samp.png'

-- this deletes the file from large object storage on db
SELECT lo_unlink(2630819);
			</pre>
        </section>
      </section>
    </section>
    <footer>
      <div class="navfooter">
        <table style="width: 100%; ">
          <tr>
            <td style="width: 40%; text-align: left; "><a accesskey="p" href="TG_Intersects.html">Prev</a> </td>
            <td style="width: 20%; text-align: center; "> </td>
            <td style="width: 40%; text-align: right; "> <a accesskey="n" href="RT_reference.html">Next</a></td>
          </tr>
          <tr>
            <td style="width: 40%; text-align: left; vertical-align: top; ">Intersects </td>
            <td style="width: 20%; text-align: center; ">
              <a accesskey="h" href="index.html">Home</a>
            </td>
            <td style="width: 40%; text-align: right; vertical-align: top; "> Chapter 11. Raster Reference</td>
          </tr>
        </table>
      </div>
    </footer>
  </body>
</html>
